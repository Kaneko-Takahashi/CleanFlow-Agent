# 要件定義書 - CleanFlow Agent

## システム概要

### プロダクト名

CleanFlow Agent

### 目的

CSV データをアップロードし、AI エージェントが自動的にデータプロファイリングと前処理プランの生成・実行を行うツール。ユーザーは分類・回帰・クラスタリングなどのタスク種別とターゲット列を指定するだけで、適切な前処理ステップ（欠損補完・エンコード・スケーリングなど）を自動生成し、実行できる。

### 想定ユーザー

- データサイエンティスト
- 機械学習エンジニア
- データ分析初心者
- データ前処理の自動化を求める開発者

## 対応データ

- **形式**: CSV（カンマ区切り）
- **構造**:
  - 行 = サンプル（データポイント）
  - 列 = 特徴量（特徴変数）
- **制約**:
  - ファイルサイズ上限（初期は 100MB 程度を想定）
  - 文字エンコーディング: UTF-8 推奨（Shift-JIS 等も対応可能）

## 機能要件

### 認証機能

#### ユーザー登録

- メールアドレス + パスワードで新規ユーザー登録
- メールアドレスの重複チェック
- パスワード強度チェック（最低 8 文字以上）
- bcrypt の 72 バイト制限チェック

#### ログイン

- メールアドレス + パスワードでログイン
- ログイン成功時に JWT アクセストークンを発行
- トークンは Authorization ヘッダで送信
- OAuth2 互換のトークンエンドポイント（Swagger UI 対応）

#### ログアウト

- トークンの無効化（MVP ではクライアント側で削除のみ）

### データセット管理機能

#### データセット作成

- ログイン中ユーザーのみ作成可能
- データセット名と説明を指定

#### データセット一覧

- ログイン中ユーザーが所有するデータセットのみ表示
- 表示項目：
  - データセット名
  - 説明
  - 作成日時

#### データセット削除（将来実装）

- 自分のデータセットのみ削除可能
- 削除時にファイルと DB レコードを削除

### データプロファイリング機能 ✅ 実装済み

#### プロファイル生成

- CSV データを分析し、統計情報を自動生成
- 各列の情報：
  - データ型（int, float, object, datetime 等）
  - データ型カテゴリ（numeric, categorical, datetime, boolean）
  - 欠損値の数・欠損率
  - ユニーク値の数・ユニーク率
  - 基本統計量（平均、中央値、標準偏差、最小値、最大値、四分位数）
  - 外れ値検出（IQR 法による）
  - カテゴリ変数の場合は頻度分布（上位 10 件）

#### データ品質問題の検出

- 高欠損率カラムの検出（50%以上: 高、10%以上: 中）
- 外れ値の多いカラムの検出（10%以上）
- 高カーディナリティカラムの検出（90%以上のユニーク率）
- 問題ごとに重要度（high/medium/low）と改善提案を提示

### 前処理プラン生成機能 ✅ 実装済み

#### タスク種別指定

- 分類（Classification）
- 回帰（Regression）
- クラスタリング（Clustering）

#### ターゲット列指定

- タスク種別に応じてターゲット列を選択
- 分類・回帰の場合は必須、クラスタリングの場合は不要

#### AI エージェントによるプラン生成

- LLM（Anthropic Claude）を使用
- データプロファイルとタスク種別・ターゲット列を入力
- 前処理ステップを JSON 形式で生成：
  - ステップの順序（order）
  - ステップ名（name）
  - 説明（description）
  - 実行コード（code_snippet: pandas/scikit-learn）
- API キー未設定時はダミープランを生成（フォールバック）

#### 生成される前処理ステップの例

- 欠損値補完（平均値、中央値、最頻値、前後の値など）
- カテゴリ変数のエンコード（One-Hot Encoding、Label Encoding）
- 数値変数のスケーリング（StandardScaler、MinMaxScaler）
- 外れ値の処理
- 特徴量選択
- データ分割（train/test）

### プラン実行機能 ✅ 実装済み

#### プラン実行

- 生成された前処理プランを実行
- pandas/scikit-learn のコードを `exec()` で実行
- 実行ログを記録（各ステップの成功/失敗、実行時間）
- オプションで CSV データを渡して実行可能
- CSV データ未指定時はサンプルデータで実行

#### Before/After サマリ表示

- 実行前のデータ形状・統計量
- 実行後のデータ形状・統計量
- 各ステップの実行結果（成功/失敗、処理時間、エラーメッセージ）
- 総実行時間

#### 実行履歴管理

- プランごとの実行履歴一覧
- 実行詳細の取得

### 前処理レシピの保存・再利用

#### プラン保存

- 生成されたプランをデータベースに保存
- プラン名を付与可能

#### プラン一覧

- ユーザーが作成したプランの一覧表示
- プラン名、作成日時、関連データセット名を表示

#### プラン再利用（将来実装）

- 保存されたプランを他のデータセットに適用

## 非機能要件

### セキュリティ

#### 認証の安全性

- パスワードはハッシュ化して保存（bcrypt、salt rounds: 12）
- JWT のシークレットキーは環境変数で管理
- トークンの有効期限設定（デフォルト: 24 時間）
- HTTPS 通信を推奨（本番環境）

#### データ分離

- ユーザー間でデータが混在しないよう、user_id で厳密に分離
- リポジトリ層で `find_by_id_and_user` メソッドを提供
- ファイルアクセス権限の適切な設定

#### コード実行の安全性

- プランのコードスニペット実行は制限された環境で実行
- 実行環境に `df`（DataFrame）と `pd`（pandas）のみを渡す
- 将来的にサンドボックス環境の強化を検討

### パフォーマンス

#### 応答時間

- ログイン: 1 秒以内
- CSV アップロード: ファイルサイズに依存（10MB で 5 秒以内）
- プロファイル生成: データセットサイズに依存（10 万行で 10 秒以内）
- プラン生成: LLM API 呼び出しを含むため 30 秒以内
- プラン実行: データセットサイズとステップ数に依存

#### スケーラビリティ

- 初期は単一サーバーで動作
- 将来的に複数インスタンス対応可能な設計

### 使用技術

#### バックエンド

- Python 3.10 以上
- FastAPI
- SQLite（開発時）、PostgreSQL（本番環境想定）
- SQLAlchemy（ORM）
- pandas / scikit-learn（データ処理）
- JWT 認証（python-jose）
- bcrypt（パスワードハッシュ化）
- pydantic-settings（設定管理）

#### LLM 連携

- Anthropic Claude API（claude-sonnet-4-20250514）
- API キー未設定時はダミープラン生成でフォールバック

### ログ・監視

#### ログ出力

- アプリケーションログ（INFO、WARNING、ERROR）
- アクセスログ（API 呼び出し）
- エラーログ（スタックトレース含む）

#### 監視項目

- API 応答時間
- エラー率
- LLM API 呼び出し回数・コスト

## 実装済み機能一覧

| 機能 | ステータス | 備考 |
|------|----------|------|
| ユーザー登録 | ✅ 実装済み | |
| ログイン（JSON） | ✅ 実装済み | |
| OAuth2トークン | ✅ 実装済み | Swagger UI対応 |
| ユーザー情報取得 | ✅ 実装済み | |
| データセット作成 | ✅ 実装済み | |
| データセット一覧 | ✅ 実装済み | |
| プラン作成 | ✅ 実装済み | |
| プラン一覧 | ✅ 実装済み | |
| プラン実行 | ✅ 実装済み | |
| 実行履歴一覧 | ✅ 実装済み | |
| 実行詳細取得 | ✅ 実装済み | |
| データプロファイリング | ✅ 実装済み | |
| LLMプラン生成 | ✅ 実装済み | ダミーフォールバック付き |

## 将来拡張

### フロントエンド連携

- Supabase / Vercel と連携したフロントエンド開発
- React / Next.js 等を使用した SPA
- リアルタイム更新（WebSocket 等）

### マルチテナント SaaS 化

- 組織・チーム機能
- データセットの共有機能
- プランの公開・共有
- サブスクリプションモデル

### 機能拡張

- CSV ファイルアップロード機能
- より高度な前処理ステップ（特徴量エンジニアリング、次元削減等）
- 複数の LLM プロバイダー対応（OpenAI、Gemini 等）
- プランのバージョン管理
- プラン編集機能（ステップの追加・削除・並べ替え）
- 実行履歴の詳細分析
- データ可視化機能
- バッチ処理機能
- 非同期実行とステータス監視
- プランテンプレート機能
